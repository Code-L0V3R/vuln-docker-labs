# Use Debian as the base image
FROM debian:latest

# Update the package list and install required dependencies
RUN apt-get update && apt-get install -y \
    wget \
    build-essential \
    libssl-dev \
    zlib1g-dev \
    libpam0g-dev

# Define the OpenSSH version
ENV OPENSSH_VERSION=8.5p1

# Download and extract OpenSSH source code
RUN wget https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-$OPENSSH_VERSION.tar.gz \
    && tar -xzf openssh-$OPENSSH_VERSION.tar.gz \
    && cd openssh-$OPENSSH_VERSION \
    && ./configure \
    && make \
    && make install

# Clean up unnecessary files
RUN rm -rf /var/lib/apt/lists/* \
    && apt-get clean \
    && rm -rf /openssh-$OPENSSH_VERSION \
    && rm -rf /openssh-$OPENSSH_VERSION.tar.gz

# Create SSH directory and generate SSH host keys
RUN mkdir -p /etc/ssh \
    && ssh-keygen -A

# Create the sshd user and group
RUN groupadd sshd && useradd -r -g sshd -d /var/run/sshd -s /usr/sbin/nologin sshd

# Modify sshd_config to set LogLevel to INFO and log output to /tmp/sshd.log
RUN sed -i 's/#LogLevel INFO/LogLevel INFO/g' /usr/local/etc/sshd_config \
    && echo "LogLevel INFO" >> /usr/local/etc/sshd_config \
    && echo "SyslogFacility LOCAL0" >> /usr/local/etc/sshd_config

# Redirect SSHD logs to /tmp/sshd.log using shell redirection
RUN touch /tmp/sshd.log && chmod 666 /tmp/sshd.log

# Expose port 22
EXPOSE 22

# Start the SSH service and tail the log
CMD ["/bin/bash", "-c", "/usr/local/sbin/sshd -D -e -ddd > /tmp/sshd.log 2>&1 & tail -f /tmp/sshd.log"]
